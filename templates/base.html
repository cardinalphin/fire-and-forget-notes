<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ title or "Fire & Forget Notes" }}</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:24px; max-width:1000px;}
    a{color:#0b63ce; text-decoration:none;}
    a:hover{text-decoration:underline;}
    .nav a{margin-right:14px; font-weight:700;}
    .card{border:1px solid #ddd; border-radius:12px; padding:12px 14px; margin:10px 0;}
    .muted{color:#666; font-size:0.92em;}
    textarea{width:100%; min-height:280px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:14px;}
    input[type=text]{width:100%; padding:8px; font-size:14px;}
    button{padding:8px 12px; border:1px solid #ccc; border-radius:10px; background:#f7f7f7; cursor:pointer;}
    button:hover{background:#eee;}
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1;}
    .right{text-align:right;}
    .pill{display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:999px; background:#fafafa; font-size:13px;}
    .danger{border-color:#f2b8b5; background:#fff5f5;}
    .flash{background:#fffbe6; border:1px solid #f0e6a6; padding:10px 12px; border-radius:12px; margin:10px 0;}
    pre{white-space:pre-wrap;}
    .note-body{white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:14px; line-height:1.35;}
    .note-body img{max-width:100%; height:auto; display:block; margin:10px 0;}
    .editor-grid{display:flex; gap:16px; align-items:flex-start;}
    .preview{border:1px solid #ddd; border-radius:12px; padding:10px; min-height:280px; background:#fafafa;}
    @media (max-width: 800px){.editor-grid{flex-direction:column;}}
    .small{font-size:13px;}
  </style>
</head>
<body>
  <div class="nav">
    <a href="/new">New</a>
    <a href="/search">Search</a>
    <a href="/browse">Browse</a>
    <a href="/tasks">Tasks</a>
    <a href="/copilot">Copilot</a>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for m in messages %}
        <div class="flash">{{ m }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% block content %}{% endblock %}
  <script>
    (function () {
      const textarea = document.querySelector('textarea[name="body"]');
      if (!textarea) return;
      const preview = document.getElementById("note-preview");

      function escapeHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function renderBody(text) {
        const tokens = [];
        const replaced = text.replace(/!\[([^\]]*)\]\((\/images\/[^)]+)\)/g, (m, alt, url) => {
          tokens.push({ alt, url });
          return `@@IMG${tokens.length - 1}@@`;
        });
        let out = escapeHtml(replaced);
        tokens.forEach((t, i) => {
          const alt = escapeHtml(t.alt);
          out = out.replace(`@@IMG${i}@@`, `<img src="${t.url}" alt="${alt}" loading="lazy">`);
        });
        return out.replace(/\n/g, "<br>\n");
      }

      function updatePreview() {
        if (!preview) return;
        preview.innerHTML = renderBody(textarea.value || "");
      }

      function insertAtCursor(el, text) {
        const start = el.selectionStart || 0;
        const end = el.selectionEnd || 0;
        const before = el.value.slice(0, start);
        const after = el.value.slice(end);
        el.value = before + text + after;
        const pos = start + text.length;
        el.setSelectionRange(pos, pos);
        el.focus();
      }

      textarea.addEventListener("paste", async (e) => {
        const items = e.clipboardData && e.clipboardData.items;
        if (!items) return;
        for (const item of items) {
          if (item.type && item.type.indexOf("image/") === 0) {
            e.preventDefault();
            const blob = item.getAsFile();
            if (!blob) return;
            const form = new FormData();
            form.append("image", blob, "pasted-image");
            const resp = await fetch("/upload", { method: "POST", body: form });
            if (!resp.ok) {
              alert("Image upload failed.");
              return;
            }
            const data = await resp.json();
            if (data && data.url) {
              insertAtCursor(textarea, "![](" + data.url + ")");
              updatePreview();
            }
            return;
          }
        }
      });

      textarea.addEventListener("input", updatePreview);
      updatePreview();
    })();
  </script>
</body>
</html>
